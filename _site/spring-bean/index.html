<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="jackhance's blog" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="jackhance's blog" /> <title> Spring 卷 - IOC 篇 - Spring Bean - jackhance's blog </title> <link rel="alternate" href="http://localhost:4000/spring-bean/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/spring-bean/" /> <meta name="description" content="Spring Bean 详解" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Spring 卷 - IOC 篇 - Spring Bean | jackhance" /> <meta property="og:title" content="Spring 卷 - IOC 篇 - Spring Bean | jackhance" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/spring-bean/" /> <meta property="og:description" content="Spring Bean 详解" /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Spring 卷 - IOC 篇 - Spring Bean | jackhance" /> <meta name="twitter:url" content="http://localhost:4000/spring-bean/" /> <meta name="twitter:site" content="@jackhance" /> <meta name="twitter:creator" content="@jackhance" /> <meta name="twitter:description" content="Spring Bean 详解" /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="jackhance's blog" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#java">JAVA</a>, <a class="tag" href="/tags/#spring">SPRING</a>, <a class="tag" href="/tags/#ioc">IOC</a>, <a class="tag" href="/tags/#bean">BEAN</a> </span> </div> <h1 class="header-title" itemprop="headline">Spring 卷 - IOC 篇 - Spring Bean</h1> <div class="post-meta"> <time datetime="2021-09-25T15:59:00+08:00" itemprop="datePublished"> Sep 25, 2021 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">jackhance</span> </span> <time hidden datetime="2021-09-25T15:59:00+08:00" itemprop="dateModified"> Sep 25, 2021 </time> <span hidden itemprop="publisher" itemtype="Person">jackhance</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><h3 id="spring-bean-的定义">Spring Bean 的定义</h3> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <h3 id="spring-bean-的定义"> <a href="#spring-bean-的定义" class="anchor-head"></a> Spring Bean 的定义 </h3> <p>每个 Spring Ioc 容器管理一个或者多个 Bean。这些 Bean 皆通过补充到 Ioc 容器的配置元信息，从而进行创建。（e.g. xml 配置文件的 <code class="language-plaintext highlighter-rouge">&lt;bean/&gt;</code> ）。</p> <p>在容器内部，Bean 的定义以 BeanDefinition 对象存在，其中 BeanDefinition 包含以下元信息:</p> <ul> <li>含包名的类名：Bean 实现类名</li> <li>Bean 的行为配置：作用域 scope 、 生命周期回调 lifecycle callback 等等</li> <li>Bean 工作时协同工作的协作方(依赖方)</li> <li>其他配置：e.g. 数据库连接池的大小</li> </ul> <p><br /></p> <hr /> <h4 id="beandefinition-的元信息"> <a href="#beandefinition-的元信息" class="anchor-head"></a> BeanDefinition 的元信息 </h4> <h5 id="beandefinition-元信息包含"> BeanDefinition 元信息包含： </h5> <ul> <li>Class：Bean 的类全名（非接口、非抽象类）</li> <li>Name：Bean 的名称或者id</li> <li>Scope：Bean 的作用域（singleton、prototype）</li> <li>Constructor arguments：Bean 的构造器参数（依赖注入）</li> <li>Properties：Bean 的属性设置</li> <li>Autowiring mode：Bean 的自动绑定模式（byName、byType）</li> <li>Lazy initialization mode：Bean 的延迟初始化模式</li> <li>Initialization method：Bean 的初始化回调方法名称</li> <li>Destruction method：Bean 的销毁回调方法名称`</li> </ul> <h5 id="beandefinition-的构造"> BeanDefinition 的构造 </h5> <p>通过 BeanDefinitionBuilder 构建</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="nc">BeanDefinitionBuilder</span><span class="o">.</span><span class="na">genericBeanDefinition</span><span class="o">(</span><span class="nc">Worker</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="c1">// 属性设置</span>
        <span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"worker-1"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">30</span><span class="o">)</span>
        <span class="c1">// 获取 BeanDefinition 实例</span>
        <span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>
</code></pre></div></div> <p>通过 AbstractBeanDefinition 以及派生类构建</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GenericBeanDefinition</span> <span class="n">genericBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericBeanDefinition</span><span class="o">();</span>
<span class="n">genericBeanDefinition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="nc">Worker</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 属性设置</span>
<span class="nc">MutablePropertyValues</span> <span class="n">mutablePropertyValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutablePropertyValues</span><span class="o">()</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"worker-1"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
<span class="n">genericBeanDefinition</span><span class="o">.</span><span class="na">setPropertyValues</span><span class="o">(</span><span class="n">mutablePropertyValues</span><span class="o">);</span>
</code></pre></div></div> <p><br /></p> <hr /> <h4 id="spring-bean-的命名"> <a href="#spring-bean-的命名" class="anchor-head"></a> Spring Bean 的命名 </h4> <p>每个 bean 都有一个或多个标识符。这些标识符在承载 bean 的容器中必须是唯一的。一个 bean 通常只有一个标识符。但是，如果它需要多个，则可以将多余的视为别名(Alias)。</p> <p>在基于 XML 的配置元数据中，您可以使用id属性、name属性或两者来指定 bean 标识符。该id属性允许您指定一个 ID。</p> <p>作为历史记录，在 Spring 3.1 之前的版本中，id属性被定义为一种<code class="language-plaintext highlighter-rouge">xsd:ID</code><sup id="xsd-id"><a href="#xsd-id-ref">[1]</a></sup>类型，它限制了可能的字符。从 3.1 开始，它被定义为一种<code class="language-plaintext highlighter-rouge">xsd:string</code><sup id="xsd-string"><a href="#xsd-string-ref">[2]</a></sup>类型。请注意，bean 的id唯一性仍然由容器强制执行，但不再由 XML 解析器强制执行。</p> <p>定义指定 id 的 bean：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BeanDefinitionRegistry</span> <span class="err">#</span> <span class="n">registerBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="o">);</span>
</code></pre></div></div> <p>倘若你不为 bean 提供一个 <code class="language-plaintext highlighter-rouge">name</code> 或 一个 <code class="language-plaintext highlighter-rouge">id</code> ，容器会为该 bean 生成一个唯一的名称。 Spring 2.0.3 引入了接口 <code class="language-plaintext highlighter-rouge">BeanNameGenerator</code> 来为 bean生成唯一的名称。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Strategy interface for generating bean names for bean definitions.
 *
 * @author Juergen Hoeller
 * @since 2.0.3
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanNameGenerator</span> <span class="o">{</span>

	<span class="cm">/**
	 * Generate a bean name for the given bean definition.
	 * @param definition the bean definition to generate a name for
	 * @param registry the bean definition registry that the given definition
	 * is supposed to be registered with
	 * @return the generated bean name
	 */</span>
	<span class="nc">String</span> <span class="nf">generateBeanName</span><span class="o">(</span><span class="nc">BeanDefinition</span> <span class="n">definition</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">BeanNameGenerator</code> 有俩个默认的实现：</p> <ul> <li><code class="language-plaintext highlighter-rouge">DefaultBeanNameGenerator</code> 默认的实现 委派给 <code class="language-plaintext highlighter-rouge">BeanDefinitionReaderUtils#generateBeanName(BeanDefinition, BeanDefinitionRegistry)</code> 命名 bean</li> <li><code class="language-plaintext highlighter-rouge">AnnotationBeanNameGenerator</code> 基于注解扫描的实现，起始于 Spring 2.5（与 <code class="language-plaintext highlighter-rouge">@Component</code> 同起始版本）</li> </ul> <p><br /></p> <hr /> <h4 id="spring-bean-的别名"> <a href="#spring-bean-的别名" class="anchor-head"></a> Spring Bean 的别名 </h4> <p>如果要为 bean 引入其他别名，也可以在name 属性中指定它们，用半角逗号 (,)、分号 (;) 或空格( )分隔。</p> <h5 id="使用xml定义"> 使用xml定义： </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">"myWorker"</span> <span class="na">alias=</span><span class="s">"systemA-worker"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">"myWorker"</span> <span class="na">alias=</span><span class="s">"systemB-worker"</span><span class="nt">/&gt;</span>
</code></pre></div></div> <p>现在，每个组件和主应用程序都可以通过一个唯一的名称来引用，并且保证不会与任何其他定义发生冲突（有效地创建一个命名空间），但它们引用的是同一个 bean。</p> <h5 id="使用注解定义"> 使用注解定义： </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义一个 id 为 worker 的 bean ，同时拥有别名 jackhance-worker</span>
<span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="o">{</span><span class="s">"worker"</span><span class="o">,</span> <span class="s">"jackhance-worker"</span><span class="o">})</span>
<span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">worker</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">();</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"worker-02"</span><span class="o">);</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"jackhance"</span><span class="o">);</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div> <p><br /></p> <hr /> <h4 id="spring-bean-的注册"> <a href="#spring-bean-的注册" class="anchor-head"></a> Spring Bean 的注册 </h4> <h5 id="xml-配置元信息注册"> xml 配置元信息注册 </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"worker"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.container.model.Worker"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"id"</span> <span class="na">value=</span><span class="s">"9527"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">value=</span><span class="s">"jackhance"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"age"</span> <span class="na">value=</span><span class="s">"25"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div> <h5 id="java-注解注册"> java 注解注册 </h5> <ul> <li><code class="language-plaintext highlighter-rouge">@Component</code> 及其”派生”注解 (e.g. <code class="language-plaintext highlighter-rouge">@Service</code>、 <code class="language-plaintext highlighter-rouge">@Controller</code> 等等)</li> <li><code class="language-plaintext highlighter-rouge">@Bean</code></li> <li><code class="language-plaintext highlighter-rouge">@Import</code></li> </ul> <h5 id="java-api-注册"> java API 注册 </h5> <ul> <li>命名方式：<code class="language-plaintext highlighter-rouge">BeanDefinitionRegistry # registerBeanDefinition(String, BeanDefinition)</code></li> <li>非命名方式：<code class="language-plaintext highlighter-rouge">BeanDefinitionReaderUtils # registerWithGeneratedName(AbstractBeanDefinition, BeanDefinitionRegistry)</code></li> <li>配置类方式：<code class="language-plaintext highlighter-rouge">AnnotatedBeanDefinitionReader # register(Class...)</code></li> </ul> <h5 id="外部单例对象注册"> 外部单例对象注册 </h5> <p><code class="language-plaintext highlighter-rouge">SingletonBeanRegistry # registerSingleton</code></p> <p>外部单例对象注册到 beanFactory ，作为 bean 托管到 beanFactory</p> <p>可通过依赖注入或者依赖查找获得 bean ，但是 beanFactory 并不管理 bean 的生命周期</p> <p><br /></p> <hr /> <h4 id="spring-bean-的实例化"> <a href="#spring-bean-的实例化" class="anchor-head"></a> Spring Bean 的实例化 </h4> <h5 id="构造器方式实例化"> 构造器方式实例化 </h5> <p>方式1 ： 通过注解构造器的方式，实例化 bean</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"worker-create-by-annotated-constructor"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">workerCreateByAnnotatedConstructor</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">();</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"pc9528"</span><span class="o">);</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"jackhance"</span><span class="o">);</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div> <p>方式2 ： 通过 xml 配置构造器的方式，实例化 bean</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"worker-create-by-xml-constructor"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.container.model.Worker"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"id"</span> <span class="na">value=</span><span class="s">"pc9527"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">value=</span><span class="s">"jackhance"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"age"</span> <span class="na">value=</span><span class="s">"30"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

</code></pre></div></div> <h5 id="静态方法方式实例化"> 静态方法方式实例化 </h5> <p>通过指定静态工厂方法，来实例化 bean ：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="o">...</span> <span class="n">getter</span> <span class="n">or</span> <span class="n">setter</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Worker</span> <span class="nf">generateWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">();</span>
        <span class="n">worker</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"9527"</span><span class="o">);</span>
        <span class="n">worker</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"jackhance"</span><span class="o">);</span>
        <span class="n">worker</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">worker</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"worker-create-by-xml-static-method"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.container.model.Worker"</span> <span class="na">factory-method=</span><span class="s">"generateWorker"</span><span class="nt">/&gt;</span>
</code></pre></div></div> <h5 id="工厂方法方式实例化"> 工厂方法方式实例化 </h5> <p>通过指定工厂方法的方式进行实例化：</p> <p>GenericWorkerFactory -&gt; WorkerFactory # createWorker :</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">WorkerFactory</span> <span class="o">{</span>

    <span class="k">default</span> <span class="nc">Worker</span> <span class="nf">createWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Worker</span><span class="o">.</span><span class="na">generateWorker</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"worker-factory"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.bean.model.GenericWorkerFactory"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"worker-create-by-xml-factory-method"</span> <span class="na">factory-bean=</span><span class="s">"worker-factory"</span> <span class="na">factory-method=</span><span class="s">"createWorker"</span><span class="nt">/&gt;</span>
</code></pre></div></div> <h5 id="factorybean-方式实例化"> FactoryBean 方式实例化 </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * {@link Worker} bean 的 {@link FactoryBean} 实现
 *
 * @author jackhance
 * @mail jackhance0825@163.com
 * @date 2021/9/29 0:13
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorkerFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Worker</span><span class="o">.</span><span class="na">generateWorker</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Worker</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>方式1 ： 通过 xml 方式实例化</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"worker-create-by-xml-factory-bean"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.bean.model.WorkerFactoryBean"</span> <span class="nt">/&gt;</span>
</code></pre></div></div> <p>方式2 ： 通过注解方式实例化</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"worker-create-by-annotated-factory-bean"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">WorkerFactoryBean</span> <span class="nf">workerCreateByAnnotatedFactoryBean</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">WorkerFactoryBean</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> <h5 id="serviceloader-方式实例化-特殊"> ServiceLoader 方式实例化 (特殊) </h5> <p>ServiceLoader 是一种特殊的服务实现方式。在实现服务的 java 平台中，可通过添加对应的服务供应实现类到类路径下，以此实现功能的扩展。</p> <p>ServiceLoader 是指定配置资源目录为 <code class="language-plaintext highlighter-rouge">META-INF/services</code> ，目录下配置的文件为服务的类型（实现接口的类全名），文件内容包含服务实现类型的列表，允许空行，一个作为一行，<code class="language-plaintext highlighter-rouge">#</code> 为注释</p> <p>e.g. :</p> <p>创建文件 META-INF/services/com.jackhance.spring.ioc.bean.model.WorkerFactory ，文件内容：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>com.jackhance.spring.ioc.bean.model.GenericWorkerFactory
</code></pre></div></div> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"workerFactoryServiceLoader"</span> <span class="na">class=</span><span class="s">"org.springframework.beans.factory.serviceloader.ServiceLoaderFactoryBean"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"serviceType"</span> <span class="na">value=</span><span class="s">"com.jackhance.spring.ioc.bean.model.WorkerFactory"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"================================= ServiceLoaderFactoryBean =============================="</span><span class="o">);</span>

<span class="nc">ServiceLoader</span> <span class="n">serviceLoader</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"workerFactoryServiceLoader"</span><span class="o">,</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="k">for</span> <span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">WorkerFactory</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">serviceLoader</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
    <span class="nc">WorkerFactory</span> <span class="n">workerFactory</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ServiceLoader : "</span> <span class="o">+</span> <span class="n">workerFactory</span><span class="o">.</span><span class="na">createWorker</span><span class="o">());</span>
<span class="o">}</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"====================== ServiceLoader # load ========================================="</span><span class="o">);</span>

<span class="n">serviceLoader</span> <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">WorkerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="k">for</span> <span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">WorkerFactory</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">serviceLoader</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
    <span class="nc">WorkerFactory</span> <span class="n">workerFactory</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ServiceLoader : "</span> <span class="o">+</span> <span class="n">workerFactory</span><span class="o">.</span><span class="na">createWorker</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div> <h5 id="autowirecapablebeanfactory--createbean-方式实例化-特殊"> AutowireCapableBeanFactory # createBean 方式实例化 (特殊) </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 通用 {@link com.jackhance.spring.ioc.container.model.Worker} 工厂
 *
 * @author jackhance
 * @mail jackhance0825@163.com
 * @date 2021/9/28 23:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericWorkerFactory</span> <span class="kd">implements</span> <span class="nc">WorkerFactory</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"@PostConstruct : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 初始化中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"InitializingBean#afterPropertiesSet() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 初始化中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doInit</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"自定义初始化方法 doInit() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 初始化中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PreDestroy</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"@PreDestroy : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 销毁中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"DisposableBean#destroy() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 销毁中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"自定义销毁方法 doDestroy() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 销毁中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">finalize</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"当前 GenericWorkerFactory 对象 name = "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 正在被垃圾回收..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBeanName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AutowireCapableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getAutowireCapableBeanFactory</span><span class="o">();</span>

<span class="nc">WorkerFactory</span> <span class="n">workerFactory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">WorkerFactory</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">createBean</span><span class="o">(</span><span class="nc">GenericWorkerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">AUTOWIRE_BY_TYPE</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

<span class="n">applicationContext</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div> <p>执行输出：</p><pre><code class="language-cmd">@PostConstruct : com.jackhance.spring.ioc.bean.model.GenericWorkerFactory 初始化中...
InitializingBean#afterPropertiesSet() : com.jackhance.spring.ioc.bean.model.GenericWorkerFactory 初始化中...
</code></pre><p>在此方式下，可通过给定的类创建一个新的 bean ，行使所有初始化行为，包含适用的 BeanPostProcessor 。</p> <p>在bean 的生命周期内，会触发初始化方法 （e.g. <code class="language-plaintext highlighter-rouge">@PostConstruct</code>、<code class="language-plaintext highlighter-rouge">InitializingBean # afterPropertiesSet</code> 等等），但不会触发销毁方法（e.g. <code class="language-plaintext highlighter-rouge">@PreDestroy</code>、<code class="language-plaintext highlighter-rouge">DisposableBean # destroy</code> 等等）</p> <p><br /></p> <hr /> <h4 id="spring-bean-的初始化"> <a href="#spring-bean-的初始化" class="anchor-head"></a> Spring Bean 的初始化 </h4> <h5 id="postconstruct-方法"> <code class="language-plaintext highlighter-rouge">@PostConstruct</code> 方法 </h5> <p>Bean 可在方法标注注解 <code class="language-plaintext highlighter-rouge">@PostConstruct</code> ，可在 Bean 初始化时触发。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericWorkerFactory</span> <span class="kd">implements</span> <span class="nc">WorkerFactory</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"@PostConstruct : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 初始化中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</code></pre></div></div> <h5 id="initializingbean--afterpropertiesset"> <code class="language-plaintext highlighter-rouge">InitializingBean # afterPropertiesSet</code> </h5> <p>Bean 实现接口 <code class="language-plaintext highlighter-rouge">InitializingBean # afterPropertiesSet</code> ，可在 Bean 初始化时触发。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericWorkerFactory</span> <span class="kd">implements</span> <span class="nc">WorkerFactory</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"InitializingBean#afterPropertiesSet() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 初始化中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</code></pre></div></div> <h5 id="自定义初始化方法"> 自定义初始化方法 </h5> <p>首先定义 Bean 的初始化方法：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericWorkerFactory</span> <span class="kd">implements</span> <span class="nc">WorkerFactory</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doInit</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"自定义初始化方法 doInit() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 初始化中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</code></pre></div></div> <p>注册 Bean 的初始化方法，有以下方式：</p> <ul> <li>XML 配置：<code class="language-plaintext highlighter-rouge">&lt;bean init-method="init" ... /&gt;</code></li> <li>Java 注解：<code class="language-plaintext highlighter-rouge">@Bean(initMethod="init")</code></li> <li>Java API：<code class="language-plaintext highlighter-rouge">AbstractBeanDefinition # setInitMethodName(String)</code></li> </ul> <h5 id="初始化方法的执行顺序"> 初始化方法的执行顺序 </h5> <ol> <li><code class="language-plaintext highlighter-rouge">@PostConstruct</code></li> <li><code class="language-plaintext highlighter-rouge">InitializingBean # afterPropertiesSet</code></li> <li>自定义初始化方法</li> </ol> <p><br /></p> <hr /> <h4 id="spring-bean-的延迟初始化"> <a href="#spring-bean-的延迟初始化" class="anchor-head"></a> Spring Bean 的延迟初始化 </h4> <p>在 Spring 容器启动时，标注了延迟初始化的 Bean 并不会初始化，初始化会发生在获取时。</p> <h5 id="xml-配置"> xml 配置 </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"worker-factory-by-xml-lazy"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.bean.model.GenericWorkerFactory"</span>
        <span class="na">init-method=</span><span class="s">"doInit"</span>
        <span class="na">destroy-method=</span><span class="s">"doDestroy"</span>
        <span class="na">lazy-init=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
</code></pre></div></div> <h5 id="注解-lazy"> 注解 <code class="language-plaintext highlighter-rouge">@Lazy</code> </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"worker-factory-create-by-annotated-lazy"</span><span class="o">,</span> <span class="n">initMethod</span> <span class="o">=</span> <span class="s">"doInit"</span><span class="o">,</span> <span class="n">destroyMethod</span> <span class="o">=</span> <span class="s">"doDestroy"</span><span class="o">)</span>
<span class="nd">@Lazy</span>
<span class="kd">public</span> <span class="nc">WorkerFactory</span> <span class="nf">annotatedLazyWorkerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">GenericWorkerFactory</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> <p><br /></p> <hr /> <h4 id="spring-bean-的销毁"> <a href="#spring-bean-的销毁" class="anchor-head"></a> Spring Bean 的销毁 </h4> <h5 id="predestroy"> <code class="language-plaintext highlighter-rouge">@PreDestroy</code> </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericWorkerFactory</span> <span class="kd">implements</span> <span class="nc">WorkerFactory</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="nd">@PreDestroy</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"@PreDestroy : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 销毁中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</code></pre></div></div> <h5 id="disposablebean--destroy"> <code class="language-plaintext highlighter-rouge">DisposableBean # destroy</code> </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericWorkerFactory</span> <span class="kd">implements</span> <span class="nc">WorkerFactory</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"DisposableBean#destroy() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 销毁中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>

<span class="o">}</span>
</code></pre></div></div> <h5 id="自定义销毁方法"> 自定义销毁方法 </h5> <p>首先定义 Bean 的销毁方法：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericWorkerFactory</span> <span class="kd">implements</span> <span class="nc">WorkerFactory</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>

    <span class="c1">// ...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"自定义销毁方法 doDestroy() : "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" 销毁中..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div> <p>然后注册 Bean 的销毁方法方式：</p> <ul> <li>XML 配置：<code class="language-plaintext highlighter-rouge">&lt;bean destroy="destroy" ... /&gt;</code></li> <li>Java 注解：<code class="language-plaintext highlighter-rouge">@Bean(destroy="destroy")</code></li> <li>Java API：<code class="language-plaintext highlighter-rouge">AbstractBeanDefinition # setDestroyMethodName(String)</code></li> </ul> <h5 id="销毁方法的执行顺序"> 销毁方法的执行顺序 </h5> <ol> <li><code class="language-plaintext highlighter-rouge">@PreDestroy</code></li> <li><code class="language-plaintext highlighter-rouge">DisposableBean # destroy</code></li> <li>自定义销毁方法</li> </ol> <p><br /></p> <hr /> <h4 id="小记"> <a href="#小记" class="anchor-head"></a> 小记 </h4> <p><small id="xsd-id-ref"><sup><a href="#xsd-id">[1]</a></sup> <a href="https://github.com/spring-projects/spring-framework/blob/3.0.x/org.springframework.beans/src/main/resources/org/springframework/beans/factory/xml/spring-beans-3.0.xsd" target="_blank"> xsd-ID 声明 </a></small></p> <p><small id="xsd-string-ref"><sup><a href="#xsd-string">[2]</a></sup> <a href="https://github.com/spring-projects/spring-framework/blob/3.1.x/org.springframework.beans/src/main/resources/org/springframework/beans/factory/xml/spring-beans-3.1.xsd" target="_blank"> xsd-string 声明 </a></small></p> <h4 id="代码"> <a href="#代码" class="anchor-head"></a> 代码 </h4> <p><a href="https://github.com/jackhance0825/thinking-in-spring-5.2.16/tree/main/bean" target="_blank"> 本篇章代码 </a></p> </div> </article> </main> <small class="post-updated-at">updated_at 25-09-2021</small> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/spring-ioc-container/" > <div class="nav-arrow">Previous</div> <span class="post-title">Spring 卷 - IOC 篇 - Spring IOC 容器</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2021</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
