<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="jackhance's blog" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="jackhance's blog" /> <title> Spring 卷 - IOC 篇 - Spring Ioc 依赖注入 - jackhance's blog </title> <link rel="alternate" href="http://localhost:4000/spring-ioc-dependency-injection/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/spring-ioc-dependency-injection/" /> <meta name="description" content="Spring Ioc 依赖注入详解" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Spring 卷 - IOC 篇 - Spring Ioc 依赖注入 | jackhance" /> <meta property="og:title" content="Spring 卷 - IOC 篇 - Spring Ioc 依赖注入 | jackhance" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/spring-ioc-dependency-injection/" /> <meta property="og:description" content="Spring Ioc 依赖注入详解" /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Spring 卷 - IOC 篇 - Spring Ioc 依赖注入 | jackhance" /> <meta name="twitter:url" content="http://localhost:4000/spring-ioc-dependency-injection/" /> <meta name="twitter:site" content="@jackhance" /> <meta name="twitter:creator" content="@jackhance" /> <meta name="twitter:description" content="Spring Ioc 依赖注入详解" /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="jackhance's blog" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#java">JAVA</a>, <a class="tag" href="/tags/#spring">SPRING</a>, <a class="tag" href="/tags/#ioc">IOC</a>, <a class="tag" href="/tags/#dependency">DEPENDENCY</a>, <a class="tag" href="/tags/#injection">INJECTION</a> </span> </div> <h1 class="header-title" itemprop="headline">Spring 卷 - IOC 篇 - Spring Ioc 依赖注入</h1> <div class="post-meta"> <time datetime="2021-10-14T22:11:00+08:00" itemprop="datePublished"> Oct 14, 2021 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">jackhance</span> </span> <time hidden datetime="2021-10-14T22:11:00+08:00" itemprop="dateModified"> Oct 14, 2021 </time> <span hidden itemprop="publisher" itemtype="Person">jackhance</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><h3 id="依赖注入的模式和类型">依赖注入的模式和类型</h3> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <h3 id="依赖注入的模式和类型"> <a href="#依赖注入的模式和类型" class="anchor-head"></a> 依赖注入的模式和类型 </h3> <h4 id="模式"> <a href="#模式" class="anchor-head"></a> 模式 </h4> <ul> <li>手动模式：通过配置或者API的方式，确定注入规则。 <ul> <li>xml 资源配置元信息，实现依赖注入</li> <li>Java 注解配置元信息，实现依赖注入</li> <li>API 配置元信息，实现依赖注入</li> </ul> </li> <li>自定模式：实现方提供依赖自动关联的方式，BeanFactory 容器按照内建的注入规则，实现依赖注入。 <ul> <li>Autowiring 自动绑定</li> </ul> </li> </ul> <h4 id="类型"> <a href="#类型" class="anchor-head"></a> 类型 </h4> <ol> <li>Setter 方法：<code class="language-plaintext highlighter-rouge">&lt;property name="worker" ref="workerBean"/&gt;</code></li> <li>构造器: <code class="language-plaintext highlighter-rouge">&lt;constructor-arg name="id" value="123" /&gt;</code></li> <li>字段: <code class="language-plaintext highlighter-rouge">@Resource Worker worker;</code></li> <li>方法: <code class="language-plaintext highlighter-rouge">@Autowire public void doWorker(Worker worker) {...}</code></li> <li>接口回调 Aware: <code class="language-plaintext highlighter-rouge">class Demo implements ApplicationContextAware {...}</code></li> </ol> <p><br /></p> <hr /> <h3 id="自动绑定autowiring"> <a href="#自动绑定autowiring" class="anchor-head"></a> 自动绑定（Autowiring） </h3> <p>什么是自动绑定呢？我从官网摘录了部分：<sup id="autowiring-collaborators"><a href="#autowiring-collaborators-ref">[1]</a></sup></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The Spring container can autowire relationships between collaborating beans. You can let Spring resolve collaborators (other beans) automatically for your bean by inspecting the contents of the ApplicationContext. Autowiring has the following advantages:

Autowiring can significantly reduce the need to specify properties or constructor arguments. (Other mechanisms such as a bean template discussed elsewhere in this chapter are also valuable in this regard.)

Autowiring can update a configuration as your objects evolve. For example, if you need to add a dependency to a class, that dependency can be satisfied automatically without you needing to modify the configuration. Thus autowiring can be especially useful during development, without negating the option of switching to explicit wiring when the code base becomes more stable.
</code></pre></div></div> <p>Spring 容器可通过自动绑定 Bean 协作者之间的关系。当然这里的 Bean 并不只是我们注册到 Spring 容器内部的，还包含了内建的 Bean ，外部的配置资源等等。因此我觉得这里用协作者是比较恰当的。</p> <p>Spring 的自动绑定包含了俩个优点：</p> <ol> <li>自动绑定显著地减少了指定属性或者构造器参数的需求。</li> <li>自动绑定会自适应配置。如<code class="language-plaintext highlighter-rouge">&lt;property name="name" ref="jackhance"/&gt;</code> ,名称为 jackhance 的 Bean 的配置变化时，这里绑定的属性会同时变化，而不像<code class="language-plaintext highlighter-rouge">&lt;property name="name" value="jackhance"/&gt;</code> 固化为 jackhance，一成不变。</li> </ol> <h4 id="自动绑定模式"> <a href="#自动绑定模式" class="anchor-head"></a> 自动绑定模式 </h4> <ul> <li>no ： 默认值，Autowiring 未激活，需要手动绑定</li> <li>byName ：依据属性的名称作为 Bean 名称进行依赖查找，并将查找到的 Bean 进行绑定</li> <li>byType ： 依据属性的类型进行依赖查找，并将查找到的 Bean 进行绑定</li> <li>constructor ：特殊 byType 类型，用于构造器参数注入</li> </ul> <p>在 Spring 中有对应的枚举，<code class="language-plaintext highlighter-rouge">org.springframework.beans.factory.annotation.Autowire</code>:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">Autowire</span> <span class="o">{</span>

	<span class="cm">/**
	 * Constant that indicates no autowiring at all.
	 */</span>
	<span class="no">NO</span><span class="o">(</span><span class="nc">AutowireCapableBeanFactory</span><span class="o">.</span><span class="na">AUTOWIRE_NO</span><span class="o">),</span>

	<span class="cm">/**
	 * Constant that indicates autowiring bean properties by name.
	 */</span>
	<span class="no">BY_NAME</span><span class="o">(</span><span class="nc">AutowireCapableBeanFactory</span><span class="o">.</span><span class="na">AUTOWIRE_BY_NAME</span><span class="o">),</span>

	<span class="cm">/**
	 * Constant that indicates autowiring bean properties by type.
	 */</span>
	<span class="no">BY_TYPE</span><span class="o">(</span><span class="nc">AutowireCapableBeanFactory</span><span class="o">.</span><span class="na">AUTOWIRE_BY_TYPE</span><span class="o">);</span>

    <span class="c1">//...</span>
<span class="o">}</span>

</code></pre></div></div> <h4 id="自动绑定的限制"> <a href="#自动绑定的限制" class="anchor-head"></a> 自动绑定的限制 </h4> <p>我从官网摘录了部分：<sup id="limitations-and-disadvantages-of-autowiring"><a href="#limitations-and-disadvantages-of-autowiring-ref">[2]</a></sup></p> <ul> <li>显式指定依赖会覆盖自动绑定。</li> <li>无法自动绑定原始类型（e.g. int、short、long）、Strings、Classes 。Spring故意这么设计的。（自动绑定本身伴随着不确定性，绑定的范围进行限定，应该是降低不确定性造成的影响）</li> <li>相比明确的绑定，自动绑定是缺乏精确性的。使用自动绑定时，Spring 需要猜测绑定的 Bean ，如果出现歧义，会产生不想期待的结果。</li> <li>若通过 setter 方法或者构造器注入时，匹配结果为多个 Bean ，但是方法期待的结果为单个 Bean ，这时会抛错。需要指定 <code class="language-plaintext highlighter-rouge">@Primary</code> 的 Bean。</li> </ul> <p><br /></p> <hr /> <h3 id="setter-方法依赖注入"> <a href="#setter-方法依赖注入" class="anchor-head"></a> Setter 方法依赖注入 </h3> <p>Setter 方法依赖注入，实现方式分为<strong>手动模式</strong>和<strong>自动模式</strong>，通过 Bean 的 setter 方法实现依赖注入。</p> <h4 id="手动模式"> <a href="#手动模式" class="anchor-head"></a> 手动模式 </h4> <h5 id="xml-资源配置元信息方式"> xml 资源配置元信息方式 </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"simpleWorker"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.dependency.injection.model.Worker"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"id"</span> <span class="na">value=</span><span class="s">"1"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">value=</span><span class="s">"jackhance-01"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"age"</span> <span class="na">value=</span><span class="s">"25"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

	<span class="c">&lt;!-- 通过 setter 方法注入 worker --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"workerHolder"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.dependency.injection.model.WorkerHolder"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"worker"</span> <span class="na">ref=</span><span class="s">"simpleWorker"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div> <p>通过 xml 配置，将 id 为 simpleWorker 的 Bean，通过 WorkerHolder#setWorker 方法，依赖注入到 id 为workerHolder 的 Bean。</p> <h5 id="java-注解配置元信息方式"> Java 注解配置元信息方式 </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * 依赖注入 {@link Worker} 对象
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">WorkerHolder</span> <span class="nf">annotatedWorkerHolder</span><span class="o">(</span><span class="nc">Worker</span> <span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">WorkerHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WorkerHolder</span><span class="o">();</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">setWorker</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div> <p>通过注解 <code class="language-plaintext highlighter-rouge">@Bean</code> 依赖注入类型为 Worker 的Bean（存在多个时，选择 primary），方法体内通过 setter 方法构建 annotatedWorkerHolder ，并注册 id 为 annotatedWorkerHolder 的 Bean 到 BeanFactory。</p> <h5 id="api-配置元信息方式"> API 配置元信息方式 </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 通过 API 配置元信息，实现 setter 方法依赖注入示例
 *
 * @author jackhance
 * @mail jackhance0825@163.com
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">APIDependencySetterInjectDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 创建 IoC 容器</span>
        <span class="nc">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultListableBeanFactory</span><span class="o">();</span>

        <span class="c1">// 读取 xml 配置到 Spring 容器，加载、解析、生成 BeanDefinition</span>
        <span class="nc">XmlBeanDefinitionReader</span> <span class="n">xmlBeanDefinitionReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">location</span> <span class="o">=</span> <span class="s">"classpath:/META-INF/ioc-dependency-injection-setter.xml"</span><span class="o">;</span>
        <span class="n">xmlBeanDefinitionReader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>

        <span class="c1">// 通过 API 创建 BeanDefinition</span>
        <span class="nc">AbstractBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="nc">BeanDefinitionBuilder</span><span class="o">.</span><span class="na">genericBeanDefinition</span><span class="o">(</span><span class="nc">WorkerHolder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">addPropertyReference</span><span class="o">(</span><span class="s">"worker"</span><span class="o">,</span> <span class="s">"simpleWorker"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>

        <span class="c1">// 注册 BeanDefinition 到 IoC 容器</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="s">"workerHolderFromAPI"</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>

        <span class="c1">// 依赖查找</span>
        <span class="nc">WorkerHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"workerHolderFromAPI"</span><span class="o">,</span> <span class="nc">WorkerHolder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="自动模式"> <a href="#自动模式" class="anchor-head"></a> 自动模式 </h4> <h5 id="byname"> byName </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

	<span class="c">&lt;!-- 通过 setter 方法 byName 方式自动注入 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"workerHolderByName"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.dependency.injection.model.WorkerHolder"</span> <span class="na">autowire=</span><span class="s">"byName"</span><span class="nt">/&gt;</span>

	<span class="c">&lt;!-- 省略其他 bean 定义 --&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div> <p>按属性名称自动装配。 Spring 查找与需要自动装配的属性同名的 bean。例如，如果一个 bean 定义被设置为按名称自动装配并且它包含一个主属性（即它有一个 setWorker(..) 方法），Spring 会查找一个名为 worker 的 bean 定义并使用它来设置属性。</p> <h5 id="bytype"> byType </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

	<span class="c">&lt;!-- 通过 setter 方法 byType 方式自动注入 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"workerHolderByType"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.dependency.injection.model.WorkerHolder"</span> <span class="na">autowire=</span><span class="s">"byType"</span><span class="nt">/&gt;</span>

	<span class="c">&lt;!-- 省略其他 bean 定义 --&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div> <p>如果容器中只存在一个属性类型的 bean，则让属性自动装配。如果存在多个（不存在 primary ），则会引发致命异常，这表明您不能为该 bean 使用 byType 自动装配。如果没有匹配的 bean，则不会发生任何事情（未设置属性）。</p> <p><br /></p> <hr /> <h3 id="构造器依赖注入"> <a href="#构造器依赖注入" class="anchor-head"></a> 构造器依赖注入 </h3> <p>构造器依赖注入实现方式分为<strong>手动模式</strong>和<strong>自动模式</strong>，通过 Bean 的构造方法实现依赖注入。</p> <h4 id="手动模式-1"> <a href="#手动模式-1" class="anchor-head"></a> 手动模式 </h4> <h5 id="xml-资源配置元信息方式-1"> xml 资源配置元信息方式 </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

	<span class="c">&lt;!-- 通过 constructor 方法注入 worker --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"workerHolder"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.dependency.injection.model.WorkerHolder"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"worker"</span> <span class="na">ref=</span><span class="s">"simpleWorker"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

	<span class="c">&lt;!-- 省略其他 bean 定义 --&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div> <p>通过 xml 配置，将 id 为 simpleWorker 的 Bean，通过 WorkerHolder 的构造方法，依赖注入到构造参数 worker。</p> <h5 id="java-注解配置元信息方式-1"> Java 注解配置元信息方式 </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/**
* 依赖注入 {@link Worker} 对象
*/</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">WorkerHolder</span> <span class="nf">annotatedWorkerHolder</span><span class="o">(</span><span class="nc">Worker</span> <span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">WorkerHolder</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <h5 id="api-配置元信息方式-1"> API 配置元信息方式 </h5> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 通过 API 配置元信息，实现 constructor 方法依赖注入示例
 *
 * @author jackhance
 * @mail jackhance0825@163.com
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">APIDependencyConstructorInjectDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 创建 IoC 容器</span>
        <span class="nc">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultListableBeanFactory</span><span class="o">();</span>

        <span class="c1">// 读取 xml 配置到 Spring 容器，加载、解析、生成 BeanDefinition</span>
        <span class="nc">XmlBeanDefinitionReader</span> <span class="n">xmlBeanDefinitionReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">location</span> <span class="o">=</span> <span class="s">"classpath:/META-INF/ioc-dependency-injection-constructor.xml"</span><span class="o">;</span>
        <span class="n">xmlBeanDefinitionReader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>

        <span class="c1">// 通过 API 创建 BeanDefinition</span>
        <span class="nc">AbstractBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="nc">BeanDefinitionBuilder</span><span class="o">.</span><span class="na">genericBeanDefinition</span><span class="o">(</span><span class="nc">WorkerHolder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="c1">// 按照构造器参数顺序添加参数</span>
                <span class="o">.</span><span class="na">addConstructorArgReference</span><span class="o">(</span><span class="s">"primaryWorker"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>

        <span class="c1">// 注册 BeanDefinition 到 IoC 容器</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="s">"workerHolderFromAPI"</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>

        <span class="c1">// 依赖查找</span>
        <span class="nc">WorkerHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"workerHolderFromAPI"</span><span class="o">,</span> <span class="nc">WorkerHolder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div> <h4 id="自动模式-1"> <a href="#自动模式-1" class="anchor-head"></a> 自动模式 </h4> <h5 id="constructor"> constructor </h5> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

	<span class="c">&lt;!-- 通过 constructor 方法 constructor 方式自动注入, 存在多个时，注入标注 primary 的 Bean --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"workerHolderByConstructor"</span> <span class="na">class=</span><span class="s">"com.jackhance.spring.ioc.dependency.injection.model.WorkerHolder"</span> <span class="na">autowire=</span><span class="s">"constructor"</span><span class="nt">/&gt;</span>

	<span class="c">&lt;!-- 省略其他 bean 定义 --&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div> <p>类似于 byType 但适用于构造函数参数。如果容器中没有一个构造函数参数类型的 bean，则会引发致命错误。</p> <p><br /></p> <hr /> <h3 id="字段依赖注入"> <a href="#字段依赖注入" class="anchor-head"></a> 字段依赖注入 </h3> <p>字段依赖注入，只支持手动模式，通过 Java 注解配置元信息实现。</p> <h4 id="autowired"> <a href="#autowired" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Autowired</code> </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/**
     * {@link Autowired} 方式依赖注入
     */</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">WorkerHolder</span> <span class="n">workerHolder1</span><span class="o">;</span>

</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">@Autowired</code> 的依赖注入，是通过 <code class="language-plaintext highlighter-rouge">AutowiredAnnotationBeanPostProcessor</code> 实现依赖注入。</p> <h4 id="resource"> <a href="#resource" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Resource</code> </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * {@link Resource} 方式依赖注入
     */</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">WorkerHolder</span> <span class="n">workerHolder2</span><span class="o">;</span>

</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">@Resource</code> 的依赖注入，是通过 <code class="language-plaintext highlighter-rouge">CommonAnnotationBeanPostProcessor</code> 实现依赖注入。</p> <h4 id="inject"> <a href="#inject" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Inject</code> </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * {@link Inject} 方式依赖注入
     */</span>
    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">WorkerHolder</span> <span class="n">workerHolder3</span><span class="o">;</span>
</code></pre></div></div> <p>JSR 330 <code class="language-plaintext highlighter-rouge">@Inject</code> 的依赖注入，是通过 <code class="language-plaintext highlighter-rouge">AutowiredAnnotationBeanPostProcessor</code> 实现依赖注入。</p> <p><br /></p> <hr /> <h3 id="方法依赖注入"> <a href="#方法依赖注入" class="anchor-head"></a> 方法依赖注入 </h3> <p>方法依赖注入，只支持手动模式，通过 Java 注解配置元信息实现。</p> <h4 id="autowired-1"> <a href="#autowired-1" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Autowired</code> </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * {@link Autowired} 方式依赖注入
     */</span>
    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init1</span><span class="o">(</span><span class="nc">Worker</span> <span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workerHolder1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WorkerHolder</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div> <h4 id="resource-1"> <a href="#resource-1" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Resource</code> </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * {@link Resource} 方式依赖注入
     */</span>
    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init2</span><span class="o">(</span><span class="nc">Worker</span> <span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workerHolder2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WorkerHolder</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div> <h4 id="inject-1"> <a href="#inject-1" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Inject</code> </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * {@link Inject} 方式依赖注入
     */</span>
    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init3</span><span class="o">(</span><span class="nc">Worker</span> <span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workerHolder3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WorkerHolder</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div> <h4 id="bean"> <a href="#bean" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Bean</code> </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * {@link Bean} 方式依赖注入，并注册 workerHolder 实例到 Spring 容器
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">WorkerHolder</span> <span class="nf">workerHolder</span><span class="o">(</span><span class="nc">Worker</span> <span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">WorkerHolder</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div> <p><br /></p> <hr /> <h3 id="回调依赖注入"> <a href="#回调依赖注入" class="anchor-head"></a> 回调依赖注入 </h3> <p>Spring 接口回调，通过 <code class="language-plaintext highlighter-rouge">Aware</code> 接口实现，组件类可以通过实现接口，实现注入指定资源。</p> <table> <thead> <tr> <th style="text-align: left"><code class="language-plaintext highlighter-rouge">Aware</code> 接口</th> <th style="text-align: center">获取的资源</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">BeanFactoryAware</td> <td style="text-align: center">获取 IoC 容器 BeanFactory</td> </tr> <tr> <td style="text-align: left">ApplicationContextAware</td> <td style="text-align: center">获取 Spring 应用上下文 ApplicationContext 对象</td> </tr> <tr> <td style="text-align: left">EnvironmentAware</td> <td style="text-align: center">获取 Environment 对象</td> </tr> <tr> <td style="text-align: left">ResourceLoaderAware</td> <td style="text-align: center">获取资源加载器对象 ResourceLoader</td> </tr> <tr> <td style="text-align: left">BeanClassLoaderAware</td> <td style="text-align: center">获取加载当前 Bean Class 的 ClassLoader</td> </tr> <tr> <td style="text-align: left">BeanNameAware</td> <td style="text-align: center">获取当前 Bean 的名称</td> </tr> <tr> <td style="text-align: left">MessageSourceAware</td> <td style="text-align: center">获取 MessageSource 对象，用于 Spring 国际化</td> </tr> <tr> <td style="text-align: left">ApplicationEventPublisherAware</td> <td style="text-align: center">获取 ApplicationEventPublisher 对象，用于 Spring 事件</td> </tr> <tr> <td style="text-align: left">EmbeddedValueResolverAware</td> <td style="text-align: center">获取 StringValueResolve 对象，用于占位符处理</td> </tr> </tbody> </table> <p><br /></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 基于 {@link Aware} 接口回调的依赖注入示例
 *
 * @author jackhance
 * @mail jackhance0825@163.com
 */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AwareInterfaceInjectDemo</span> <span class="kd">implements</span> <span class="nc">BeanFactoryAware</span><span class="o">,</span> <span class="nc">ApplicationContextAware</span><span class="o">,</span> <span class="nc">ResourceLoaderAware</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">BeanFactory</span> <span class="n">beanFactory</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 创建应用上下文</span>
        <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>

        <span class="c1">// 注册注册类</span>
        <span class="n">applicationContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">AwareInterfaceInjectDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// 启动应用上下文</span>
        <span class="n">applicationContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

        <span class="c1">// 省略业务逻辑...</span>

        <span class="c1">// 关闭应用上下文</span>
        <span class="n">applicationContext</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBeanFactory</span><span class="o">(</span><span class="nc">BeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setResourceLoader</span><span class="o">(</span><span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div> <p><br /></p> <hr /> <h3 id="依赖注入类型选择"> <a href="#依赖注入类型选择" class="anchor-head"></a> 依赖注入类型选择 </h3> <h4 id="构造器注入使用场景"> <a href="#构造器注入使用场景" class="anchor-head"></a> 构造器注入使用场景 </h4> <p>Spring 团队通常<strong>提倡</strong>构造函数注入，因为它可以让您将应用程序组件实现为不可变对象，并确保所需的依赖项不是null。此外，构造函数注入的组件总是以完全初始化的状态返回给客户端（调用）代码。</p> <p>但是，大量的构造参数会降低代码的可读性，同时，也代表此类的职责不够单一，应该考虑重构。</p> <p>因此，<code class="language-plaintext highlighter-rouge">在强依赖、低依赖场景，选构造器注入。</code></p> <h4 id="setter-方法注入使用场景"> <a href="#setter-方法注入使用场景" class="anchor-head"></a> Setter 方法注入使用场景 </h4> <p>对于强制依赖项的构造器注入，可选依赖项使用 Setter 方法注入是一种比较优雅的方式。可以在类中配置合理的默认值的可选依赖项，通过 Setter 方法注入有选择性注入依赖。</p> <p>但是，依赖注入的顺序，完全依赖于用户的操作顺序，如果依赖项存在前后依赖关系，使用此方式，会存在隐患。</p> <p>因此，<code class="language-plaintext highlighter-rouge">在多依赖场景，选 Setter 方法注入。</code></p> <h4 id="字段注入使用场景"> <a href="#字段注入使用场景" class="anchor-head"></a> 字段注入使用场景 </h4> <p>字段注入方式，通过 <code class="language-plaintext highlighter-rouge">@Autowired</code> 、<code class="language-plaintext highlighter-rouge">@Resource</code>、<code class="language-plaintext highlighter-rouge">@Inject</code> 或者自定义注解，标注到字段上，就可以实现依赖注入，这种方式对于我们写程序是很便利的。</p> <p>但是，这种方式无论在 Spring 或者 Spring Boot 官网上，作者偏好于构造器注入，字段注入是处于准备淘汰的状态。</p> <p>因此，<code class="language-plaintext highlighter-rouge">字段注入方式，简单便利。</code></p> <h4 id="方法注入使用场景"> <a href="#方法注入使用场景" class="anchor-head"></a> 方法注入使用场景 </h4> <p>使用方法注入时，更建议使用 <code class="language-plaintext highlighter-rouge">@Bean</code> 注解注入参数，Spring 会依赖注入参数到方法，在 Bean 构造的情况下，这其实是一种组合方式，先通过注解依赖注入，在通过手动 API 注入参数，构造 Bean。</p> <p>因此，<code class="language-plaintext highlighter-rouge">声明类，选方法注入。</code></p> <p><br /></p> <hr /> <h3 id="限定注入"> <a href="#限定注入" class="anchor-head"></a> 限定注入 </h3> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 组注解，基于 {@link Qualifier}
 *
 * @author jackhance
 * @mail jackhance0825@163.com
 */</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="nd">@Qualifier</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Group</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div> <p><br /></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="n">worker</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"worker4"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="n">qualifierWorker</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">workers</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">qualifierWorkers</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Group</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">groupWorkers</span><span class="o">;</span>

    <span class="cm">/**
     * worker1、worker2
     * 逻辑分组 @Qualifier ： worker3、worker4
     * 自定义逻辑分组 @Group ： worker5 、 worker6
     */</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">worker1</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">buildWorker</span><span class="o">(</span><span class="s">"1"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nd">@Primary</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">worker2</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">buildWorker</span><span class="o">(</span><span class="s">"2"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 基于 {@link Qualifier} 逻辑分组
     */</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Qualifier</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">worker3</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">buildWorker</span><span class="o">(</span><span class="s">"3"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 基于 {@link Qualifier} 逻辑分组
     */</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Qualifier</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">worker4</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">buildWorker</span><span class="o">(</span><span class="s">"4"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 自定义逻辑分组
     */</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Group</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">worker5</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">buildWorker</span><span class="o">(</span><span class="s">"5"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 自定义逻辑分组
     */</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Group</span>
    <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">worker6</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">buildWorker</span><span class="o">(</span><span class="s">"6"</span><span class="o">,</span> <span class="s">"jackhance"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">buildWorker</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">();</span>
        <span class="n">worker</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">worker</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">worker</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">age</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">worker</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 创建应用上下文</span>
        <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>

        <span class="c1">// 注册注册类</span>
        <span class="n">applicationContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">QualifierInjectDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// 启动应用上下文</span>
        <span class="n">applicationContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

        <span class="nc">QualifierInjectDemo</span> <span class="n">demo</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">QualifierInjectDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// 期待输出 worker2 Bean</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"demo.worker = "</span> <span class="o">+</span> <span class="n">demo</span><span class="o">.</span><span class="na">worker</span><span class="o">);</span>
        <span class="c1">// 期待输出 worker4 Bean</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"demo.qualifierWorker = "</span> <span class="o">+</span> <span class="n">demo</span><span class="o">.</span><span class="na">qualifierWorker</span><span class="o">);</span>
        <span class="c1">// 期待输出 worker1-6</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"demo.workers = "</span> <span class="o">+</span> <span class="n">demo</span><span class="o">.</span><span class="na">workers</span><span class="o">);</span>
        <span class="c1">// 期待输出 worker3 worker4 worker5 worker6</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"demo.qualifiedUsers = "</span> <span class="o">+</span> <span class="n">demo</span><span class="o">.</span><span class="na">qualifierWorkers</span><span class="o">);</span>
        <span class="c1">// 期待输出 worker5 worker6</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"demo.groupWorkers = "</span> <span class="o">+</span> <span class="n">demo</span><span class="o">.</span><span class="na">groupWorkers</span><span class="o">);</span>

        <span class="c1">// 关闭应用上下文</span>
        <span class="n">applicationContext</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div> <p><br /></p> <p>output:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>demo.worker = Worker{id='2', name='jackhance', age=30, hash=945591847}
demo.qualifierWorker = Worker{id='4', name='jackhance', age=30, hash=328827614}
demo.workers = [Worker{id='1', name='jackhance', age=30, hash=109228794}, Worker{id='2', name='jackhance', age=30, hash=945591847}, Worker{id='3', name='jackhance', age=30, hash=561959774}, Worker{id='4', name='jackhance', age=30, hash=328827614}, Worker{id='5', name='jackhance', age=30, hash=2110756088}, Worker{id='6', name='jackhance', age=30, hash=580871917}]
demo.qualifiedUsers = [Worker{id='3', name='jackhance', age=30, hash=561959774}, Worker{id='4', name='jackhance', age=30, hash=328827614}, Worker{id='5', name='jackhance', age=30, hash=2110756088}, Worker{id='6', name='jackhance', age=30, hash=580871917}]
demo.groupWorkers = [Worker{id='5', name='jackhance', age=30, hash=2110756088}, Worker{id='6', name='jackhance', age=30, hash=580871917}]
</code></pre></div></div> <p><br /></p> <p>通过控制台打印输出，我们可以看出：</p> <ul> <li><code class="language-plaintext highlighter-rouge">qualifierWorker</code> 注入指定名字为 worker4 的 Bean 实例；</li> <li><code class="language-plaintext highlighter-rouge">workers</code> 注入了所有类型的 <code class="language-plaintext highlighter-rouge">Worker</code> Bean 实例；</li> <li><code class="language-plaintext highlighter-rouge">qualifiedUsers</code> 注入了标注了 <code class="language-plaintext highlighter-rouge">@Qualifier</code> 和 <code class="language-plaintext highlighter-rouge">@Group</code> 所有类型的 <code class="language-plaintext highlighter-rouge">Worker</code> Bean 实例；</li> <li><code class="language-plaintext highlighter-rouge">groupWorkers</code> 注入了标注了 <code class="language-plaintext highlighter-rouge">@Group</code> 所有类型的 <code class="language-plaintext highlighter-rouge">Worker</code> Bean 实例；</li> </ul> <h4 id="qualifier-的作用"> <a href="#qualifier-的作用" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Qualifier</code> 的作用 </h4> <ol> <li>指定注入特定 id 的 Bean（ e.g. <code class="language-plaintext highlighter-rouge">@Qualifier("worker4")</code> ）;</li> <li><code class="language-plaintext highlighter-rouge">@Qualifier</code> 及其”派生注解”（ e.g. <code class="language-plaintext highlighter-rouge">@Group</code> ） 可以起到分组作用；</li> <li><code class="language-plaintext highlighter-rouge">@Qualifier</code>以及”派生注解”标注的分组（ e.g. Spring Cloud 的 <code class="language-plaintext highlighter-rouge">@LoadBalanced</code> ），父元标注包括子元标注；</li> </ol> <h4 id="qualifier-是如何指定-bean-注入"> <a href="#qualifier-是如何指定-bean-注入" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Qualifier</code> 是如何指定 Bean 注入 </h4> <p><code class="language-plaintext highlighter-rouge">@Qualifier</code> 的如何匹配 Bean 实现精确依赖注入的？</p> <p>详见 <code class="language-plaintext highlighter-rouge">QualifierAnnotationAutowireCandidateResolver # checkQualifier</code> 源码 ：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
	 * Match the given qualifier annotations against the candidate bean definition.
     *
     * @param bdHolder 进行匹配的 {@link BeanDefinitionHolder}
     * @param annotationsToSearch 被依赖注入的 Bean 的注解
     * @return 是否匹配
	 */</span>
	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">checkQualifiers</span><span class="o">(</span><span class="nc">BeanDefinitionHolder</span> <span class="n">bdHolder</span><span class="o">,</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotationsToSearch</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">annotationsToSearch</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nc">SimpleTypeConverter</span> <span class="n">typeConverter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleTypeConverter</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">Annotation</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">annotationsToSearch</span><span class="o">)</span> <span class="o">{</span><span class="c1">// 被依赖注入的 Bean 的注解</span>
			<span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">annotationType</span><span class="o">();</span>
			<span class="kt">boolean</span> <span class="n">checkMeta</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="kt">boolean</span> <span class="n">fallbackToMeta</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isQualifier</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span><span class="c1">// 被依赖注入的 Bean 的注解是 @Qualifier 或者 元标注@Qualifier的注解 或者 自定义Qualifier注解</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">checkQualifier</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">,</span> <span class="n">annotation</span><span class="o">,</span> <span class="n">typeConverter</span><span class="o">))</span> <span class="o">{</span><span class="c1">// 是否匹配</span>
					<span class="n">fallbackToMeta</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span><span class="c1">// 不满足匹配，检查注解的元标注</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">checkMeta</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span><span class="c1">// 已经匹配，不再需要检查注解的元标注</span>
				<span class="o">}</span>
			<span class="o">}</span>
            <span class="c1">// 检查注解的元标注是否满足匹配</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">checkMeta</span><span class="o">)</span> <span class="o">{</span>
				<span class="kt">boolean</span> <span class="n">foundMeta</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
				<span class="k">for</span> <span class="o">(</span><span class="nc">Annotation</span> <span class="n">metaAnn</span> <span class="o">:</span> <span class="n">type</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">())</span> <span class="o">{</span>
					<span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">metaType</span> <span class="o">=</span> <span class="n">metaAnn</span><span class="o">.</span><span class="na">annotationType</span><span class="o">();</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">isQualifier</span><span class="o">(</span><span class="n">metaType</span><span class="o">))</span> <span class="o">{</span><span class="c1">// 注解的元标注是 @Qualifier 或者 元标注@Qualifier的注解 或者 自定义Qualifier注解</span>
						<span class="n">foundMeta</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
						<span class="k">if</span> <span class="o">((</span><span class="n">fallbackToMeta</span> <span class="o">&amp;&amp;</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">metaAnn</span><span class="o">)))</span> <span class="o">||</span><span class="c1">// 检查注解的元标注，拥有 value 值的 @Qualifier 的匹配</span>
								<span class="o">!</span><span class="n">checkQualifier</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">,</span> <span class="n">metaAnn</span><span class="o">,</span> <span class="n">typeConverter</span><span class="o">))</span> <span class="o">{</span><span class="c1">// 是否匹配 value 值</span>
							<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">fallbackToMeta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">foundMeta</span><span class="o">)</span> <span class="o">{</span><span class="c1">// 注解的元标注找不到 Qualifier，不满足匹配</span>
					<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span><span class="c1">// 匹配</span>
	<span class="o">}</span>

    <span class="cm">/**
	 * Match the given qualifier annotation against the candidate bean definition.
	 */</span>
	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">checkQualifier</span><span class="o">(</span>
			<span class="nc">BeanDefinitionHolder</span> <span class="n">bdHolder</span><span class="o">,</span> <span class="nc">Annotation</span> <span class="n">annotation</span><span class="o">,</span> <span class="nc">TypeConverter</span> <span class="n">typeConverter</span><span class="o">)</span> <span class="o">{</span>

		<span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">annotationType</span><span class="o">();</span>
		<span class="nc">RootBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RootBeanDefinition</span><span class="o">)</span> <span class="n">bdHolder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>

        <span class="c1">// BeanDefinition 是否有指定的依赖注入候选Qualifier，可通过 {@link AbstractBeanDefinition#addQualifier} 注册</span>
		<span class="nc">AutowireCandidateQualifier</span> <span class="n">qualifier</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="na">getQualifier</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">qualifier</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">qualifier</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="na">getQualifier</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getShortName</span><span class="o">(</span><span class="n">type</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">qualifier</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 首先，获取 BeanDefinition 此类型的注解</span>
			<span class="nc">Annotation</span> <span class="n">targetAnnotation</span> <span class="o">=</span> <span class="n">getQualifiedElementAnnotation</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
			<span class="c1">// 找不到，然后找工厂方法此类型的注解</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">targetAnnotation</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">targetAnnotation</span> <span class="o">=</span> <span class="n">getFactoryMethodAnnotation</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
			<span class="o">}</span>
            <span class="c1">// 找不到，然后找 RootBeanDefinition 此类型的注解</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">targetAnnotation</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">RootBeanDefinition</span> <span class="n">dbd</span> <span class="o">=</span> <span class="n">getResolvedDecoratedDefinition</span><span class="o">(</span><span class="n">bd</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">dbd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">targetAnnotation</span> <span class="o">=</span> <span class="n">getFactoryMethodAnnotation</span><span class="o">(</span><span class="n">dbd</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
            <span class="c1">// 找不到，找目标类此类型的注解</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">targetAnnotation</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Look for matching annotation on the target class</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">getBeanFactory</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">().</span><span class="na">getType</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">beanType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">targetAnnotation</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getUserClass</span><span class="o">(</span><span class="n">beanType</span><span class="o">),</span> <span class="n">type</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// Not the usual case - simply forget about the type check...</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">targetAnnotation</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span><span class="o">.</span><span class="na">hasBeanClass</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">targetAnnotation</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getUserClass</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getBeanClass</span><span class="o">()),</span> <span class="n">type</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
            <span class="c1">// 若 bdHolder 持有的 BeanDefinition 的注解一样，返回匹配</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">targetAnnotation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">targetAnnotation</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">annotation</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

        <span class="c1">// 注解不一致，则获取注解的属性，属性是否匹配</span>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">getAnnotationAttributes</span><span class="o">(</span><span class="n">annotation</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">attributes</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">qualifier</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// If no attributes, the qualifier must be present</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">attributes</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">attributeName</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span><span class="c1">// 被依赖注入的 Bean 的属性键值</span>
			<span class="nc">Object</span> <span class="n">expectedValue</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span><span class="c1">// 被依赖注入的 Bean 的期待值</span>
			<span class="nc">Object</span> <span class="n">actualValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span><span class="c1">// 进行匹配 Bean 对应属性键的值</span>
			<span class="c1">// 检查依赖注入候选Qualifier的期待值</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">qualifier</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">actualValue</span> <span class="o">=</span> <span class="n">qualifier</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">attributeName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">actualValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Fall back on bean definition attribute</span>
				<span class="n">actualValue</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">attributeName</span><span class="o">);</span>
			<span class="o">}</span>
            <span class="c1">// 特殊处理值为 #{value} 的 attributeName ，Bean 的名称是否匹配 @Qualifier("beanName") 里面的 #{beanName}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">actualValue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">attributeName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">AutowireCandidateQualifier</span><span class="o">.</span><span class="na">VALUE_KEY</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">expectedValue</span> <span class="k">instanceof</span> <span class="nc">String</span> <span class="o">&amp;&amp;</span> <span class="n">bdHolder</span><span class="o">.</span><span class="na">matchesName</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">expectedValue</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// Fall back on bean name (or alias) match</span>
				<span class="k">continue</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">actualValue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">qualifier</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Fall back on default, but only if the qualifier is present</span>
				<span class="n">actualValue</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">getDefaultValue</span><span class="o">(</span><span class="n">annotation</span><span class="o">,</span> <span class="n">attributeName</span><span class="o">);</span>
			<span class="o">}</span>
            <span class="c1">// actualValue 类型转换</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">actualValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">actualValue</span> <span class="o">=</span> <span class="n">typeConverter</span><span class="o">.</span><span class="na">convertIfNecessary</span><span class="o">(</span><span class="n">actualValue</span><span class="o">,</span> <span class="n">expectedValue</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
			<span class="o">}</span>
            <span class="c1">// actualValue 是否匹配 被依赖注入的 Bean 的期待值</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">expectedValue</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">actualValue</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="cm">/*
* &lt;pre&gt;
*    逻辑分析：
*
*    约定：
*        Q：@Qualifier 或者 元标注@Qualifier的注解 或者 自定义Qualifier注解
*        match：注解equals 或者 注解的全部 attribute 值都匹配
*    
*    若被依赖的 Bean 不存在注解 Q ？ 若被依赖的 Bean 注解的元标注不存在注解 Q ？ BeanDefinition 匹配
*                                                                        ： 若被依赖的 Bean 注解的元标注 match ？ BeanDefinition 匹配 ： BeanDefinition 不匹配
*                                : 若被依赖的 Bean 注解 match ? BeanDefinition 匹配
*                                                        : 若被依赖的 Bean 注解的元标注不存在注解 Q ？ BeanDefinition 不匹配
*                                                                                                ： 若被依赖的 Bean 注解的元标注 match ？ BeanDefinition 匹配 ： BeanDefinition 不匹配
* &lt;/pre&gt;
*/</span>
</code></pre></div></div> <p><br /></p> <hr /> <h3 id="延迟依赖注入"> <a href="#延迟依赖注入" class="anchor-head"></a> 延迟依赖注入 </h3> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * {@link Autowired} {@link Lazy}延迟注入
     */</span>
    <span class="nd">@Autowired</span>
    <span class="nd">@Lazy</span>
    <span class="kd">private</span> <span class="nc">Worker</span> <span class="n">lazyWorker1</span><span class="o">;</span>

    <span class="cm">/**
     * {@link Inject} {@link Lazy}延迟注入
     */</span>
    <span class="nd">@Inject</span>
    <span class="nd">@Lazy</span>
    <span class="kd">private</span> <span class="nc">Worker</span> <span class="n">lazyWorker2</span><span class="o">;</span>

    <span class="cm">/**
     * {@link Resource} {@link Lazy}延迟注入
     */</span>
    <span class="nd">@Resource</span>
    <span class="nd">@Lazy</span>
    <span class="kd">private</span> <span class="nc">Worker</span> <span class="n">lazyWorker3</span><span class="o">;</span>

    <span class="cm">/**
     * {@link ObjectProvider} 延迟注入
     */</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">objectProvider</span><span class="o">;</span>

    <span class="cm">/**
     * {@link ObjectFactory} 延迟注入
     */</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">objectFactory</span><span class="o">;</span>
</code></pre></div></div> <p><br /></p> <hr /> <h3 id="依赖注入过程"> <a href="#依赖注入过程" class="anchor-head"></a> 依赖注入过程 </h3> <p>处理入口：<code class="language-plaintext highlighter-rouge">DefaultListableBeanFactory#resolveDependency</code></p> <h3 id="autowired-注入原理"> <a href="#autowired-注入原理" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Autowired</code> 注入原理 </h3> <ul> <li>处理器：<code class="language-plaintext highlighter-rouge">AutowiredAnnotationBeanPostProcessor</code> <ul> <li>通过 <code class="language-plaintext highlighter-rouge">AnnotationConfigUtils#registerAnnotationConfigProcessors</code> 注册</li> </ul> </li> <li>注入类型 <ul> <li>非静态字段</li> <li>非静态方法</li> <li>构造器</li> </ul> </li> </ul> <p><br /></p> <hr /> <h3 id="java-通用注解注入原理jsr250"> <a href="#java-通用注解注入原理jsr250" class="anchor-head"></a> Java 通用注解注入原理（JSR250） </h3> <ul> <li>处理器：<code class="language-plaintext highlighter-rouge">CommonAnnotationBeanPostProcessor</code> <ul> <li>通过 <code class="language-plaintext highlighter-rouge">AnnotationConfigUtils#registerAnnotationConfigProcessors</code> 注册</li> </ul> </li> <li>注入注解： <ul> <li>javax.xml.ws.WebServiceRef</li> <li>javax.ejb.EJB</li> <li>javax.annotation.Resource</li> </ul> </li> <li>生命周期注解： <ul> <li>javax.annotation.PostConstruct</li> <li>javax.annotation.PreDestroy</li> </ul> </li> </ul> <p><br /></p> <hr /> <h3 id="inject-注入原理jsr330"> <a href="#inject-注入原理jsr330" class="anchor-head"></a> <code class="language-plaintext highlighter-rouge">@Inject</code> 注入原理（JSR330） </h3> <ul> <li>处理器：<code class="language-plaintext highlighter-rouge">AutowiredAnnotationBeanPostProcessor</code> <ul> <li>通过 <code class="language-plaintext highlighter-rouge">AnnotationConfigUtils#registerAnnotationConfigProcessors</code> 注册</li> </ul> </li> </ul> <p><br /></p> <hr /> <h3 id="自定义注解驱动的依赖注入"> <a href="#自定义注解驱动的依赖注入" class="anchor-head"></a> 自定义注解驱动的依赖注入 </h3> <p>可基于 <code class="language-plaintext highlighter-rouge">AutowiredAnnotationBeanPostProcessor</code> 实现</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
     * 自定义方式一：
     * 覆盖 {@link AutowiredAnnotationBeanPostProcessor} 注册
     *
     * @see AnnotationConfigUtils#registerAnnotationConfigProcessors
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">AutowiredAnnotationBeanPostProcessor</span> <span class="nf">beanPostProcessor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">AutowiredAnnotationBeanPostProcessor</span> <span class="n">beanPostProcessor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AutowiredAnnotationBeanPostProcessor</span><span class="o">();</span>

        <span class="c1">// @Autowired + @Inject +  新注解 @CustomInject</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;&gt;</span> <span class="n">autowiredAnnotationTypes</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="nc">Autowired</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Inject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">CustomInject</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        
        <span class="n">beanPostProcessor</span><span class="o">.</span><span class="na">setAutowiredAnnotationTypes</span><span class="o">(</span><span class="n">autowiredAnnotationTypes</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">beanPostProcessor</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div> <p><br /></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * 自定义方式二：
     *
     * 自定义注解驱动
     */</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Order</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">LOWEST_PRECEDENCE</span> <span class="o">-</span> <span class="mi">3</span><span class="o">)</span>
    <span class="nd">@Scope</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">AutowiredAnnotationBeanPostProcessor</span> <span class="nf">beanPostProcessor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">AutowiredAnnotationBeanPostProcessor</span> <span class="n">beanPostProcessor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AutowiredAnnotationBeanPostProcessor</span><span class="o">();</span>
        <span class="n">beanPostProcessor</span><span class="o">.</span><span class="na">setAutowiredAnnotationType</span><span class="o">(</span><span class="nc">CustomInject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">beanPostProcessor</span><span class="o">;</span>
    <span class="o">}</span>

</code></pre></div></div> <p><br /></p> <hr /> <h3 id="小记"> <a href="#小记" class="anchor-head"></a> 小记 </h3> <p><small id="autowiring-collaborators-ref"><sup><a href="#autowiring-collaborators">[1]</a></sup> <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-autowire" target="_blank"> Autowiring Collaborators </a></small></p> <p><small id="limitations-and-disadvantages-of-autowiring-ref"><sup><a href="#limitations-and-disadvantages-of-autowiring">[1]</a></sup> <a href="https://docs.spring.io/spring-framework/docs/5.2.16.RELEASE/spring-framework-reference/core.html#beans-autowired-exceptions" target="_blank"> limitations and disadvantages of autowiring </a></small></p> <p><br /></p> <hr /> <h3 id="代码"> <a href="#代码" class="anchor-head"></a> 代码 </h3> <p><a href="https://github.com/jackhance0825/thinking-in-spring-5.2.16/tree/main/ioc-dependency-injection" target="_blank"> 本篇章代码 </a></p> </div> </article> </main> <small class="post-updated-at">updated_at 14-10-2021</small> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/spring-ioc-dependency-lookup/" > <div class="nav-arrow">Previous</div> <span class="post-title">Spring 卷 - IOC 篇 - Spring Ioc 依赖查找</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2021</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
